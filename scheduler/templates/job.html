{# Displays details for a job with recent execution results.                            #}
{# Expecting parameters                                                                 #}
{#  job: A Job. (None is not expected)                                                  #}
{#  runjobs: A list of most recent executed Jobs, or empty list (None is not expected). #}
<!DOCTYPE html>
{% import urllib %}
<html>
    <head>
        <meta charset="UTF-8">
        <link href="{{ static_url("css/tpa.css") }}" rel="stylesheet" type="text/css">
        <title>TPA Job Details</title>
    </head>
    <body>
        <div id="body">
            [<a href="/">index</a>]
            <h1>Job</h1>
            {% set s = '{}:{}'.format(job.resource_config_filename, job.translation_config_filename) %}
            {% set param = urllib.quote(s, safe='') %}
            <h2>Outline</h2>
            <p>
            <table id="logs">
                <tr><th>Name</th><td>{{job.name}}</td></tr>
                <tr><th>Description</th><td>{{job.description}}</td></tr>
                <tr><th>Status</th><td>{{job.status}}</td></tr>
                <tr><th>Scheduled at</th><td>n/a</td></tr>
                {% set param2 = urllib.quote(job.resource_config_filename, safe='') %}
                <tr><th>Resource Config File</th><td><a href="/resource_config/{{param2}}">{{job.resource_config_filename}}</a> (<a href="/transifex_slugs/{{param}}">view slugs</a>)</td></tr>
                <tr><th>Translation Config File</th><td>{{job.translation_config_filename}}</td></tr>
            </table>
            </p>
            <hr>

            <h2>Recent Results</h2>
            <p>
            {% if job.class_name == 'ResourceUploaderJob' %}
            <table id="logs">
                <tr><th>Status</th><th>Datetime</th><th>Results</th></tr>
                {% for j in runjobs %}
                    {% set param = urllib.quote(j.get_log_dir(), safe='') %}
                    {% set datetime = j.get_exec_datetime() %}
                    {% set status = j.get_exec_status() %}
                    {% set results = j.get_exec_result_string() %}
                    <tr><td><a href="/log/{{param}}">{{status}}</a><td>{{datetime}}</td><td>{{results}}</td></td></tr>
                {% end %}
            </table>
            {% end %}

            {% if job.class_name == 'TranslationUploaderJob' %}
            <table id="logs">
                <tr><th>Status</th><th>Datetime</th><th>Results</th></tr>
                {% for j in runjobs %}
                    {% set param = urllib.quote(j.get_log_dir(), safe='') %}
                    {% set datetime = j.get_exec_datetime() %}
                    {% set status = j.get_exec_status() %}
                    {% set results = j.get_exec_result_string() %}
                    {% if 'https' in results %}
                        <tr><td><a href="/log/{{param}}">{{status}}</a><td>{{datetime}}</td><td>{% raw results %}</td></td></tr>
                    {% else %}
                        <tr><td><a href="/log/{{param}}">{{status}}</a><td>{{datetime}}</td><td>{{results}}</td></td></tr>
                    {% end %}
                {% end %}
            </table>
            {% end %}
            </p>
            <hr>

            <h2>Execute Job</h2>
            <p>Job can be executed manually by clicking <i>Execute</i> buttion. It may take time to reflesh this page to show results of the execution.</p>
            <p><b>CAUTION: Manual execution may introduce unexpected uploads against fixed uploading schedules.</b></p>
            {% if job.class_name == 'TranslationUploaderJob' %}
                <form id="exec_job" action="/run/{{job.id}}" method="post">
                    <input type="radio" name="language_completion" value="all" disabled> All languages need to be completed per resource.<br>
                    <input type="radio" name="language_completion" value="any" disabled> Any languages can be completed per resource.<br>
                    <input type="hidden" name="job_id" value={{job.id}}>
                    <input type="submit" value="Execute">
                </form>
            {% else %}
                <form id="exec_job" action="/run/{{job.id}}" method="post">
                    <input type="hidden" name="job_id" value={{job.id}}>
                    <input type="submit" value="Execute">
                </form>
            {% end %}
        </div>
    </body>
</html>
                                       
